Documentation for the program "fourfit"
-- last update 2024.3.22
---------------------------------------

COMMAND NAME:   fourfit

SYNOPSIS:  Performs fringe searching for continuum MkIV data

SYNTAX:  fourfit [-aeptx] [-b BB:F] [-c controlfile] [-d device]
            [-f value] [-m value] [-n value] [-r afile] [-s naps]
            [-P polar_pair] [-T trefoffs] [-X] data file list
            [set <control file syntax statements>]
         Where all arguments except the data file list are optional,
         except when the [-r afile] option is present in which case
         the data file list is ignored.  All option flags must appear
         before the data file list (if no -r).  Option flags can come
         in any order and simple flags (a,e,p,t and x may be combined).

         The "set" option comes last and has the effect of appending
         (last word: over-riding previous directives).

    Here are examples of command-line invocations of fourfit, with
    an explanation of what they do:

fourfit -pat -c control 101-0620/3C279.051V4B set freqs a b
        Test mode, steps through all baselines polarizations for
        this scan.  Without the -pat, the fringes would just be
        written in individual files in 101-0620, with one file
        per baseline-pol-frequency group type. Accounting is on.
        All channels are ignored except a and b.

fourfit -r refr_list -c control -d hardcopy -b AT:S
        Process all data referenced by type 2 lines in the A-file
        named "refr_list", use control file "control", print the
        fringe plot on the default printer, process only baseline
        AT frequency subgroup S.

OPTION FLAGS:
        -a
            If specified, this option switches on accounting
            of CPU time and wall-clock time used in the various
            parts of fourfit.  When the program finishes, it
            produces a summary of these timing statistics.

        -b BB:F
            Allows the user to override the control file
            with a specification of the baseline and/or
            frequency group to be processed.  The syntax is
            flexible.  0, 1 or 2 characters before the colon
            refer to the baseline (one character is interpreted
            as a station), and 0 or 1 character after the colon
            is interpreted as the frequency subgroup.  You can
            use the control file wildcard character '?' in
            the baseline, but remember to protect it from the
            C-shell either by escaping it with a backslash '\'
            or enclosing the entire -b argument in single
            quotes.  If you wish only to specify the baseline,
            the colon may be omitted.  An error in the -b
            flag argument causes the flag to be ignored, and
            fourfit will continue execution.

        -c controlfile
            Specifies the file which contains parameters
            to control the operation of the program.  If
            absent, fourfit will use only the file pointed to
            by the environment variable DEF_CONTROL, which
            in turn defaults to $FF/cf_default as defined
            in the $HOPS/setup.csh file.  Any parameters
            set in a control file specified with the -c option
            override the default file values.  A description
            of the syntax of the control file, with an example,
            can be found later in this document.

        -d display_device
            Upon completion of a fringe fit, fourfit optionally
            display the results using ghostscript (gs) as configured
            when you build fourfit.  Valid "display_device" choices:

                hardcopy          print via lpr or lpr -P MK4_PRINTER
                pshardcopy        print the plot via pplot_print
                xwindow           displays it with the gs 'x11' device
                psscreen          displays it with default gs device.
                diskfile?file.ps  save the plot in "file.ps"
                ps2pdf?file.ps    use "file.ps" to make "file.pdf"

            Case is ignored.  For GS options, start with: gs --help.

            When a %d (or other integer) is found in the 'file' part of
            the argument, an incrementing number will be used (over the
            life of fourfit).  You may also use %B, %F and %P to have
            the baseline, frequency group and polarization inserted in
            place of those two-character combinations.  The ? here is
            any character that the shell is happy with.  %P does not
            work in all cases due to some nasty history.

        -e
            If specified, this option estimates the time required for
            processing by fringing the first scan and crudely extrapolating
            to the remaining scans.  It activates -a and -t; only the
            first data file mentioned will be included in the estimate.

        -f first channel
            overrides the default first channel (0) to facilitate
            plotting when there are more than 16 channels (see -n).
            See -n and display_chans option for the control file below.

        -m value
            This flag controls the verbosity of the program via
            the integer argument "value", which is forced to the
            range [-3,3].  Exceptionally 4 may be used which prints
            nothing except the fringe name.

        -n number of channels
            This reduces the number of displayed channels from the
            default of all channels.  See -f above as well as the
            display_chans directive for the control file.

        -p 
            This is equivalent to "-d psscreen", see -d above.

        -r afile
            Puts fourfit into "refringe" mode.  Fourfit refringing
            is driven by an A-file input, which overrides any 
            correlator root files directly specified on the command
            line (i.e. the latter are ignored when the -r flag
            is specified).  The input A-file, of which there can
            be only one, may contain root, corel or fringe lines,
            but only the (type 2) fringe lines are used to determine
            which data to process, by baseline and frequency subgroup.
            Obviously, the -r flag is inconsistent with the -u
            flag, and specifying both is an error.  Note that for
            afiles using HP-1000 (version 1) line formats, fourfit
            has to pre-check the disk for the existence of the 
            type 2 files.  The data area is controlled by the
            DATADIR environment variable.  It defaults to the
            value of $CORDATA.

        -s naps
            This parameter controls how many AP's are merged
            together into each plotting segment. Thus the number
            of time points shown in the phase, amplitude, and
            validity plots is so controlled. Additionally, the
            ph/seg and amp/seg statistics are calculated based
            upon the stated number of AP's in each segment.

        -t
            This flag places fourfit in test mode.  Everything
            works as normal, except that the output file is not
            written to disk, and the root file is not updated.
            This is useful when experimenting with different
            fringe-fitting strategies, in order to avoid cluttering
            up the disk.

        -x
            This is equivalent to "-d xwindow", see -d above.

        -P pp
            Controls polarization processing, where the 2 character
            string pp is one of four cross-polarization 
            states: LL, RR, LR, or RL.  Additional modes are possible
                'all'  adds data from all polarizations present
                'I'    forms a Stokes I from presumed linear pols
            and using '+' a sum of up to 4 pol products co-added.
            (With the exception of 'I', fourfit does not care that
            the polarizations are linear or circular...it just adds
            what it has.  Rudimentary support for co-adding circular
            pols likely requires correct setting of the mount_type.)

        -T trefoffs
            If this option is invoked, the fourfit reference
            time will be calculated by taking the nominal scan
            start time from the ovex file and adding trefoffs
            (which is a positive integer # of seconds) to it.

        -X
            Forces fourfit to write cross-power spectra into
            type 230 records. This option is typically used for
            import into AIPS or diagnostics.

ARGUMENTS:  data file list
            This mandatory argument or arguments tells fourfit
            which data files to process.  The format of the data
            file specification is the standard one for all HOPS
            software.  You may specify individual filenames, 
            scan directories which contain data files, 
            experiment directories, or any combination of
            these three.  In the latter two cases,
            fourfit will descend the directory tree looking for
            data files to add to its internal list of files to
            process.  Only root files need be specified.  The
            data files actually fringe-searched are determined
            by the combination of the root files specified and the
            restrictions imposed by the control file or control
            parameter list (see below).  In the absence of 
            such restrictions, all data associated with the 
            specified root files are processed.

        The postscript rendering is performed by ghostscript
        [gs(1)], and GS_* environment variables can be used
        to produce a variety of graphics when the "psscreen"
        (see -d above).  For example,

        GS_OPTIONS=-sOutputFile=abc.png GS_DEVICE=png16 \
        fourfit ...

        will generate a 16-color PNG plot.

        set <control file syntax statements>
            This command line argument is optional, and
            is intended to permit rapid, temporary modification
            of 'fourfit' behavior without the need to edit the
            control file.  The word "set" tells fourfit to expect
            additional control information on the rest of the
            command line.  The syntax of this control information
            is identical to that of the control file (see
            detailed description below).  The control file
            parser will detect syntax errors and abort if you
            do not follow the rules.  The control information you
            specify after the "set" argument on the command line
            applies to all data to be processed, and overrides
            whatever the control file itself specified for the
            parameters in question.

ENVIRONMENT:    DEF_CONTROL, DISPLAY, DATADIR, GS_DEVICE, GS_OPTIONS,
                HOPS_PLOT_DATA_MASK, HOPS_AMP_SEG_FILTER, HOPS_EST_PC_BIAS,
                HOPS_EST_PC_DLYM, ARCH, HOPS_FF_PHASE_CLR, HOPS_PLOT_DATA_MASK

DESCRIPTION:

Fourfit is the functional analogue of FRNGE on the HP-1000 systems, and
searches the data represented by the root and corel files for fringes,
writing the results of the search to files of type fringe.  The emphasis
in the design of the program has been speed and flexibility, particularly
with regard to future enhancements (of which there have been a great many).

Algorithmically, the program was closely modelled on FRNGE, with minor
enhancements, but evolution has made a number of structural changes.
The HOPS3 era ends in 2024, with a captured version that will stop evolving.
The HOPS4 era then begins with a more robust framework allowing greater
future flexibility.

Here is a (nonsensical) sample of a control file to give you an idea
what it looks like.  As there are now over 100 directives, this is
necessarily limited to some basic ones.

* global commands come first
ref_freq  8213.15
start -10

if station L and f_group X
   freqs a+ b c d- e f g h
   pc_phases abcdefgh 5 -11 12 38 -56 13.2 11 -29
   pc_mode ap_by_ap
   pc_freqs abcdefgh 10 10 1010 10 1010 10 1010 1010

if station L and f_group S
   pc_phases ijkmn 4.5 -78 39 +12 0
   pc_mode normal

if station A
   pc_mode multitone
   pc_period 30
   pc_tonemask abcdefgh 0 0 8 0 4 0 5 0
   pc_phases_l abcdefgh 12 13 11 12 24 -6 38 110
   pc_phases_r abcdefgh 11 29 14 11 64 -2 44 132
   samplers 2 abcd efgh
   pc_delay_l 30.2
   pc_delay_r -5.9
   ionosphere 18.0

* all windows are in usec, but the delay rate plot is in ns/s
* with a range typically in ps/s
if (station V or baseline KT) and source 3C279
   sb_win -0.5 0.5    mb_win 0.02 0.02  dr_win -1.0E-6 0.5E-6
else
   sb_win 0.0 0.0     mb_win 0.02 0.02  dr_win -1.0E-6 0.5E-6

if scan 288-210210
   sb_win .37 .37

if scan > 289-132510
   skip true

if baseline K? and not scan 250-120000 to 251-235959
   switched scan_start
   period 30
   gates abcfgh  0 30  0 10  15 25     0 10  15 25  0 30
* End of sample control file


SELECTOR KEYWORDS     VALUES
   station            1 character
   baseline           2 characters
   source             string of 1-8 chars
   f_group            1 character
   scan               UT-epoch (special format), or:
                      < UT-epoch
                      > UT-epoch
                      UT-epoch1 to UT-epoch2  (inclusive time range)



SYNTACTIC KEYWORDS
   if
   else
   and
   or
   not
   <>
   to
   ?

ACTION KEYWORDS         VALUES
   adhoc_amp          float
   adhoc_file         string
   adhoc_file_chans   string
   adhoc_flag_file    string
   adhoc_period       float
   adhoc_phase        'sinewave', 'polynomial', or 'file'
   adhoc_poly         <7 floats/integers (mixture OK)
   adhoc_tref         float
   avxpzoom           2 floats
   avxplopt           2 int
   chan_ids           n char string, followed by n floats
   clone_ids          a 2n-char string
   clone_snr_chk      `true' or `false` (default: false)
   chan_notches       an (n-char) string
   dc_block           `true' or `false' (default: false)
   dec_offset         float
   delay_offs         n char string, followed by n floats
   delay_offs_l       n char string, followed by n floats
   delay_offs_r       n char string, followed by n floats
   delay_offs_x       n char string, followed by n floats
   delay_offs_y       n char string, followed by n floats
   display_chans      n-char-string (channels to display; cf -f and -n)
   dr_win             2 floats
   est_pc_manual      int
   fmatch_bw_pct      float
   freqs              n chars
   frqs               n char string
   gates              n char string, followed by 2n floats
   gen_cf_record      'true' or 'false' (default: false)
   index              n ints
   interpolator       'iterate' or 'simul' (default: simul[taneous])
   ionosphere         float
   ion_npts           int
   ion_smooth         'true' or 'false' (default: false)
   ion_win            2 floats
   lsb_offset         float
   mb_win             2 floats
   mbd_anchor         'sbd' or 'model' (default: model)
   min_weight         float
   mbdrplopt          3 ints
   mod4numbering      `true' or `false'
   polfringnames      `true' or `false'
   mount_type         'no_mount', 'cassegrain', 'nasmythleft' or 'nasmythright'
   noautofringes      `true' or `false'
   notches            2n floats
   optimize_closure   'true' or 'false' (default: false)
   passband           2 floats
   pc_amp_hcode       float
   pc_delay_l         float
   pc_delay_r         float
   pc_delay_x         float
   pc_delay_y         float
   pc_phase_offset_l  float
   pc_phase_offset_r  float
   pc_phase_offset_x  float
   pc_phase_offset_y  float
   pc_phases          n char string, followed by n floats
   pc_phases_l        n char string, followed by n floats
   pc_phases_r        n char string, followed by n floats
   pc_phases_x        n char string, followed by n floats
   pc_phases_y        n char string, followed by n floats
   pc_freqs           n char string, followed by n floats
   pc_mode            `normal', `ap_by_ap', `manual', or 'multitone'
   pc_period          int
   pc_tonemask        n char string, followed by n floats
   period             int
   plot_data_dir      string
   fringeout_dir      string
   ra_offset          float
   ref_freq           float
   samplers           int, followed by up to 8 strings
   sampler_delay_l    up to 8 floats
   sampler_delay_r    up to 8 floats
   sampler_delay_x    up to 8 floats
   sampler_delay_y    up to 8 floats
   sb_win             2 floats
   skip               `true' or `false'
   start              integer
   station_delay      float
   stop               integer  
   switched           `scan_start' or `each_minute'
   t_cohere           float
   use_samples        `true' or `false'
   weak_channel       float

KEYWORD SEMANTICS

**scan selection**

   skip          if this is set to true in the body of an if_block, then
                 any scans matching the if conditions will be skipped. 
                 Note: as of 99.2.19 fourfit will not properly skip data 
                 if f_group is specified.

**filtering**    determines whether or not each AP is accepted

   freqs         controls which frequency channels get included in the fit.
                 The letters a-p correspond to the order that the frequencies
                 appear in the root file (assuming 16 channels). With no
                 suffix, DSB is implied if both sidebands are present.
                 A plus suffix denotes USB, a minus is used for LSB.
                 After 26 channels, the uppercase alphabet is used,
                 then 10 digits, finally '$' and '%' (i.e. 64 channels).
   frqs          same as freqs, but presented as a string (no spaces).
                 Additional handling is applied, so that ~ represents a
                 range of channels (e.g. a~d is abcd).  If channel aliasing
                 is in effect, % is converted to an alias of the preceding
                 channel (and consumes a letter in the process; see NOTE).
                 The +/- sideband indicators still have their usual meanings.
                 If you've already used frqs in the control file, then
                 in the 'set' command you can only adjust with freqs.
   start         start time for data to be included.
   stop          stop    "   "    "  "   "    "
                 Arguments of start and stop are integers with an optional
                 minus sign. A positive integer is interpreted as an
                 absolute time in seconds past the hour (of the scan
                 start time). When a minus sign precedes the start time
                 it is considered to be a time relative to, and later
                 than, the scheduled scan start. Similarly, a negative
                 stop time precedes the scheduled scan stop time, by
                 the indicated number of seconds.
   switched      turns on (frequency) switched mode, which discards some AP's
                 and keeps others, depending on a gating waveform
   period        period in seconds of the gating waveform
   gates         for each freq. channel, the starting delay and duration, in
                 seconds, of the gating waveform
   passband      lower and upper bounds (in MHz) of the spectral passband of
                 data to be accepted, specified as RF frequencies. If the
                 lower bound is greater than the upper bound, the range
                 wraps around -- allowing a band in the middle to be
                 excluded.  The data is rescaled so as to preserve the
                 amplitude observable (as if the data excluded were perfectly
                 valid); this means that the area under cross-power spectral
                 plot amplitude curve is approximately conserved.
                 Note: passband and notches should not both be applied;
                 you will get a warning (just in case you know what you are
                 doing) in the fourfit plot, but no fatal error.
   notches       a list of non-overlapping lower/upper bounds pairs (in MHz)
                 to exclude from the spectral passband.  (Passband may be
                 applied prior to removal of these notches.)  Note that the
                 amplitude modification calculus isn't sufficiently
                 sophisticated to detect overlaps of passband and notches,
                 so be sure to keep your surgeries disjoint.  (A large number
                 is supported and you will get a complaint if you exceed it.)
                 As with passband, the spectral data is rescaled so that
                 the amplitude observable is in some sense preserved.
                 Note: passband and notches should not both be applied;
                 you will get a warning (just in case you know what you are
                 doing) in the fourfit plot, but no fatal error.
   chan_notches  Nominally an n-char string of channel labels (freqs/frqs)
                 corresponding directly to the list of notches.  You may use
                 an @ character to have notches apply to all channels, and
                 if frqs has been used ~ may be used for a range of channels.
                 Finally @|N will be treated as a string of N channels marked
                 with @.  (Here N is not to be confused with channel N.)  For
                 robustness, it is an error if the expanded length of the
                 string does not match the number of notches (which must have
                 previously been declared).
   dc_block      if set to true, zero out lowest cross-power spectral
                 channel; useful for suppressing DC bias
   min_weight    fraction of data which must be present for inclusion.
                 Normally, a weight between 0.0 and 1.0 is provided by
                 the correlator to represent the fraction of data actually
                 supporting the correlation value.  If you specify a minimum
                 weight, any AP not meeting this threshold will be discarded.

**search**       control the fringe-searching process

   sb_win        single band delay search window bounds, in us
   mb_win        multiband     "     "      "       "     "  "; if the upper
                 bound (2nd number) is less than the lower bound (1st
                 number), then fourfit performs a "wrap-around" search, in
                 order to handle the case of a delay near to the multiband
                 (semi-) ambiguity.
   dr_win        delay_rate search window bounds, in us/s 
   ion_npts      number of evaluation points in ionospheric coarse search
   ion_smooth    if true, use alternative search on smoothed TEC grid points
   ion_win       ionospheric coarse search window in TEC units
   ra_offset     apply right asc.offset (asec) to re-center search windows
   dec_offset      "   declination  "   (asec) "      "        "      "
   interpolator  selects method of fit interpolation. Classically, an
                 iterative search has been done over sbd, mbd, drate, one
                 dimension at a time, for 3 cycles. The simultaneous mode
                 (simul for brevity) constructs a 5x5x5 cube of data points
                 and does a 3D quintic interpolation.

**corrections**  apply corrections to the data, either before or after fit

   pc_mode   specify phase_cal mode:
              - normal (model linear in time is extracted from the data)
              - manual (specified totally by the user) 
              - ap_by_ap (phase cal is extracted independently for each AP)
                DEPRECATED: use normal or manual with pc_period 1 or more
              - multitone (all tones in band are coherently fit, and phase 
                is extrapolated to the center of the band).
   pc_phases phase_cal phases in deg, for each of the listed freq channels;
             these offset phases are added to the underlying model, as
             specified by pc_mode, above. If 2 polarizations are present,
             the same values are applied to both pols.
   pc_phases_l specified in same manner as pc_phases, but the tone phases
             so specified are applied only to the first pol (L, X, or H)
   pc_phases_r specified in same manner as pc_phases, but the tone phases
             so specified are applied only to the second pol (R, Y, or V)
   pc_phases_x synonym for pc_phases_l (see)
   pc_phases_y synonym for pc_phases_r (see)
   pc_freqs  phase cal tone frequencies in KHz, for each of the listed
             freq channels iff not in range -64..64. Inside of this
             range, the value is interpreted as a tone #, with 1 being
             the 1st USB tone, 2 being the 2nd USB tone, etc. Negative
             tone #'s are used for LSB tones.
   pc_period in multitone mode (only), the phase can be estimated
             and applied over each pc_period ap's, thus removing slopes
             or other drifts in pcal (default is 9999)
   pc_tonemask - in multitone mode (only):
             The values for pc_tonemask form a bit-masked map of which 
             tones to *exclude* for this frequency channel. Thus 1 
             excludes the lowest tone, 2 the next lower tone, 4 the 3rd 
             lowest tone, etc. A value of 5, for example, would exclude 
             the lowest and the 3rd lowest tones (perhaps 10 KHz and 2.01
             MHz).  
   pc_delay_l a time value in ns representing the difference between the
   pc_delay_r the travel time from the feed phase center to the pcal
             injection point, minus the the travel time from the pcal
             pulse generator to the injection point. It is specified
             separately for the two polarization senses.
   pc_delay_x
   pc_delay_y synonyms for pc_delay_l and pc_delay_r (see)
   pc_phase_offset_x
   pc_phase_offset_y a single additive phase given in degrees, which is
             applied to the pcal phase of every channel associated with a given
             polarization (also pc_phase_offset_l and pc_phase_offset_r)
   lsb_offset additive phase in degrees, for the LSB relative to the USB;
             often necessary when correlating VLBA data against Mk 3
   ref_freq  specifies a frequency in MHz at which the phase delay
             is determined (default is total LO of first frequency)
   adhoc_phase specify mode of ad hoc phase corrections. No corrections
             are made if this isn't present, or is set to false.
   adhoc_period  For ad hoc sinewave model; the period in integer seconds.
   adhoc_amp      "   "  "     "       "    amplitude in degrees of phase.
   adhoc_tref    For both ad hoc phase models; the reference time in seconds
             past the most recent hour.
   adhoc_poly For the ad hoc phase polynomial model; From 1-6 coefficients
             describing a power-series model in time. (deg/sec^n)
   adhoc_flag_file  Name of the file containing adhoc flagging.  Lines of this
             contain times (floating point days from beginning of year) and
             character strings to impose data flagging at a particular time
             (which remains in effect until the next time mentioned).  The
             character string has two characters per channel with a nonzero
             bit for data to be retained with the bit assignments as follows:
             (msb)USB-RL,LSB-RL,USB-LR,LSB-LR,USB-RR,LSB-RR,USB-LL,LSB-LL(lsb)
             If the string is too short, the last byte will be replicated to
             the remaining channels, so a single FF is adquate to retain all
             or a single 00 to discard all.
   adhoc_file Name of the file containing phases in the ad hoc file mode.
   adhoc_file_chans String of channel labels for phases (columns) in the
             ad hoc file.
   use_samples   If true, use the sampler statistics (aka state counts) to
             normalize the raw correlation sums to the equivalent analog
             correlation.
   ionosphere specified per station, in TEC (10^16/m^2) units
   t_cohere  coherence time used in fringe fit (default is infinite)
   delay_offs delay offsets (ns) to be applied to each of the listed freq
             channels. This correction is made prefit, similar to pcal.
   delay_offs_l same as above, but restricted to LCP.
   delay_offs_r same as above, but restricted to RCP.
   delay_offs_x same as above, but restricted to X linear pol.
   delay_offs_y same as above, but restricted to Y linear pol.
   samplers  the number of samplers, followed by the freq channel 
             identifiers of channels that share a common sampler are
             grouped together in strings. In multitone mode only, the
             averaged tone-derived differential delays are applied to 
             all channels sharing a sampler.
   optimize_closure modifies fine fringe search so as to minimize the
             contribution of non-closing delay errors to the closure phase;
             can result in poorer single-baseline fits
   station_delay a priori guess at the delay of the pcal path, from maser
             to the digitizers (ns). Recommended to use 
             sampler_delay_l/r/x/y instead.
   mbd_anchor controls the basis for choosing the mbd ambiguity when
             forming the total. If 'sbd' then the ambiguity closest to
             the singleband delay is chosen; if 'model' then the
             ambiguity closest to the a priori model is chosen.
   sampler_delay_l indexed by sampler, it is the center of the window
             in which the pcal delay ambiguity will be resolved. Just like
             the old station_delay, but now broken down by sampler and
             polarization, since their cabling and filters will lead
             to different delays. For LCP, in units of ns.
   sampler_delay_r same as the above, but for RCP, instead of LCP.
   sampler_delay_x synonym for sampler_delay_l.
   sampler_delay_y synonym for sampler_delay_r.
   mount_type allows one to specify one of these: 'no_mount', 'cassegrain',
             'nasmythleft' or 'nasmythright' on a per-station basis.  If a
             station is specified as other than no_mount, then a field
             rotation angle correction will be made.  This currently is
             an experimental feature, and only applies to non-mixed,
             circular polarization fringe products.  The parallactic angle
             and elevation angles are currently evaluated only at the start
             of the scan.

** miscellaneous functions or capabilites **

   chan_ids      changes the assignment of the channel labels
                 "abcdef..xyzABC..XYZ01..789$%" from the default values
                 to the ones (MHz) specified by the corresponding list of floats
                 This is useful to prevent mis-matched IFs within an experiment
                 from causing the same channel label to be ambiguously used on
                 various baselines.  (Values within 0.01 MHz are a match.)
                 Note that this directive must appear prior to any mention of
                 channels by id (as the mapping is changed with this command).
   clone_ids     adds additional channels as clones of existing channels.
                 This provides a pathway for special editing of channels that
                 are created by output bands which need, e.g. different phases
                 in different parts of frequency space.  As with chan_ids, this
                 directive must appear before mention of the new channels.
                 If chan_ids is used, chan_ids must appear before clone_ids.
                 The argument is an even length string with the channels to
                 clone followed by the channel labels to use.  The first half
                 should correspond to recorded channels, the second half should
                 not.  (The maximum number of frequencies, including the
                 clones, is limited to 64, for a variety of reasons.)
   clone_snr_chk when true, checks SNR and raises 'C' quality code flag.  For
                 correct SNR estimates, no bits should be used twice (NYI).
   fringeout_dir if present will (create and) use this directory for output
                 fringes rather than co-location with the correlated data.
                 This must be an absolute pathname.  Subdirectories for
                 experiment name and scan will then be created along with
                 a bogus root file (so that the niceties are preserved).
   plot_data_dir if present will be used as a path to dump the plot data
                 in a self-documented ascii form to allow export of plot
                 information to other arenas (specialized plots, &c).  One
                 file per fringe is written; more help is available within
                 the files that are produced: there is help for the options
                 that may be used to manipulate the content.
   fmatch_bw_pct associate freqs < this percentage of bw together (25% default)
   pc_amp_hcode  generate an H code iff any pcal amps less than this
                 value (0.005 by default)
   weak_channel  the ratio of single_channel_amp to coherent_sum_amp 
                 below which a G code is assigned to the scan (0.5 default)
   gen_cf_record if true, saves the full control file in the fringe record
   est_pc_manual if nonzero, estimates manual pc_phase_? and delay_offs_?
                 values. A value >0/<0 estimates ref/rem station values.
                 The magnitude is a mask of bits indicating what and how
                 to make estimates; too estimate phase: include 0x01.
                 For delay there are several options: 0x02 to use the median
                 of the individual channel sbd values, 0x04 to use the average
                 of the sbd channel values, 0x08 uses the total sbd value, or
                 0x10 use the computed per-channel sbd delays. The bit 0x20
                 (in addition) activates heuristics to discard outliers.
                 0x40 reports a phase measurement that is usable via the
                 pc_phase_offset_? value.  Finally, 0x80 can be used to
                 supply a phase bias via an environment variable
                 (HOPS_EST_PC_BIAS, i.e. this shifts all channel phases).
                 Calculations are made with channels in the -f and -n range
                 (inclusive).  Conflicting commanding on the delay options
                 results in no corrections.  The phase calculation normally
                 provides values that remove the MBD (according to the setting
                 of mbd_anchor).  An environment variable HOPS_EST_PC_DLYM may
                 be set to provide a multipler on this correction:  0.0 will
                 not correct delay but will line up the phases, 0.5 will only
                 correct half of the delay (e.g. which could be used as part
                 of an iterative process), and 1.0 is the default which
                 chooses phases to remove the MBD.  If 0x100 is set (for the
                 0x02..0x08 methods), the delay so calculated is transferred
                 to the sbd values.  In this case an environment variable
                 HOPS_EST_PC_MDLY is used.  In all of these cases the output is
                 text suitable for inclusion in a control file.  (Note that
                 the fourfit control parser only works with base-10 integers,
                 sos setting 0x100 really means add 256 to 2, 4 or 8.)
                 A script est_manual_phases.py is available to drive a full
                 determination of manual pc phases using these options.
                 Note that the -f and -n options restrict the output to that
                 range of channels, independent of display_chans.
   avxpzoom      a pair of numbers that allows you to "zoom in" on the average
                 cross-power spectrum plot.  The first number is the location
                 (in plot window x coordinates, ranging from 0.0 to 1.0) of
                 interest and the second number is the width (again in plot
                 window x coordinates).  This is useful to use with the
                 passband option. ('avxp' is short for averaged cross-power.)
   avxplopt      two numbers providing options for plotting of this window.
                 The second number can be -7, -1, 0, 1 or +7.  The default
                 behavior obtains with 0.  With non-negative values, the
                 amplitude is plotted first, with negative values, the phase
                 is plotted first--0 and 1 are equivalent.  With +/-7 the
                 phase points will be connected with a faint reddish line.
                 The first number (useful when passband is active) is an
                 amplitude threshold (in pixels, defaulting to 20) for
                 amplitude/phase data to be discarded.  The fourier transform,
                 interpolation and smoothing process generate small values
                 which clutter the plot and it is usually better to discard
                 them.  This is only done for nonzero values of the second
                 number.  The RGB values in the +/-7 option may be set as
                 you like using HOPS_FF_PHASE_CLR to be a cvs triplet of
                 red,green,blue on a 0..1 scale (see pgplot documentation).
   mbdrplopt     three integers affecting the delay and MBD delay-rate plots.
                 If the first number is non-zero, the stacking of the traces
                 is reversed (i.e. MBD first, delay-rate second).  The second
                 integer is a divider for the horizontal axis to show
                 increasingly more detail at the center of the plot.  The
                 third integer does the same, but for the SBD plot.
                 ('mbdr' is short for multi-band delay-rate.)
   mod4numbering if 'true' forces the fringe numbers to be chosen
                 to be well-ordered with polarization, specifically 1..4
                 cycle through LL, RR, LR and RL.  There is no
                 guarantee that there are no gaps in the numbering.
                 Other pol cases revert to normal(sequential) numbering.
   polfringnames if 'true' put a polarization label in the fringe
                 name: NNNN -> NNNN-PP.  This option is independent of
                 mod4numbering and one may do either or both, but the results
                 may not work for all uses.  The only supported pol'n options
                 are LL,RR,LR and RL (or X or Y substitions).  Other cases
                 revert to normal(no pol label in fringe name).  This option
                 is in development and should not yet be used for production.
   noautofringes if 'true' will skip fringes for auto correlations as an
                 alternative to more complex logic in the control file.
   display_chans a channel character string using the same syntax as frqs.
                 Optionally, @N may appear at the end, which means to skip
                 N correlated channels between the displayed ones.  In the
                 32 channel era, this allows you to do, e.g. @4 so that only
                 7-8 channels are displayed.  @0 is implied if @N is missing.
                 When display_chans is used, -f and -n further reduce the
                 list of channels to be displayed.  In all cases, the first,
                 last and "All" plots are ensured to be present.  (Note that
                 "All" is automatically dropped when only one channel is to
                 be plotted.)  What you get is not always what you thought.

NOTE:
   As there are many special purpose features that have been introduced,
   it is not necessarily the case that all options work in all situations.
   (This is especially true as geodetic and astronomic back ends diverge.)

SPECIAL KEYWORD VALUES
   ?         wild card character
   keep      32767
   discard       0
   true          1
   false         0
   
QUALITY CODES
   Fourfit plots show fringe quality and/or error codes.  Quality starts at
   9 and falls as the time and freq phase and amp exceed theoretical limits.
   A qcode of 0 means no fringe (PFD > 1E-4).

ERROR CODES
   A  Trying to use both passband and notches.  This is maybe not horrible
      if the notches are tiny...but proper accounting of SNR is failing.
   B  Some form of interpolation error, usually due to fringes at the
      edge of some window
   C  Some sort of channel cloning error when clone_snr_check is used.
   D  missing track
   E  Solution is at the edge of some window.
   F  Originally meant no data found; now notes Station Unit "forks"
      (whatever that means)
   G  Shows there is a "weak" channel when the SNR > 20
   H  Indicates there are one or more weak phase cals in normal mode.
      In multitone mode, it means the average pcal amplitude is below
      threshold.  Note that some tones may be weak but not generate H.

SPECIAL FORMATS
   UT-epochs:  UT-epochs are expressed in the format ddd-hhmmss, where all 10
           characters are necessary, including leading 0's if
           appropriate.  This format will match that of a scan directory,
           if the UT-epoch that is being specified is an actual scan time.

GENERAL GUIDELINES

   1) White space is ignored; i.e., multiple spaces and line feeds all
      collapse to a single space.
   2) Multiple commands per line are fine.
   3) Comments: anything from an asterisk through the end of the line
      is ignored.
   4) Nested ifs are not allowed.  The logical operators, in decreasing
      order of precedence are (not, and, or) and that seems sufficient.
      (The plan was to allow parentheses and more complicated logic, but
      that was never implemented.)
   5) Wildcard "?" matches any single character for f_group, station, or
      baseline, any string (of up to 8 characters) for source, and any
      time-value for scan.  Remember to escape it if you use it on the
      command line.
   6) Phase cal and delay offsets are treated station by station. If not
      in a "station context", then values are applied to remote stn only.
   7) Only freqs that are chosen for both stations in a baseline are 
      present in the fit.
   8) If multiple if-blocks match a particular passes' choice of baseline,
      f_group, source, and scan criteria, then the later values assigned
      to each parameter overwrite the earlier ones.

eof
